# redis如何实现主从复制

## 什么是主从复制

```shell
127.0.0.1:6379> help slaveof

  SLAVEOF host port
  summary: Make the server a replica of another instance, or promote it as master. Deprecated starting with Redis 5. Use REPLICAOF instead.
  since: 1.0.0
  group: serve
```

假设server1执行了

​	slaveof server2的ip server2的端口

那么server1便变成了server2的从服务器，通过复制功能，server1与server2的数据保持同步



## 为什么需要主从复制

* 提高redis的并发能力

  主服务器负责写入命令，从服务器负责读取命令，从服务器分担了部分请求，整体而言提高了并发能力

  对于相同数据，只能存在一个主服务器负责写入；但可以将数据按一定规则分配给多个主服务器负责，提升写入能力

* 数据容灾

  当主服务器挂了时，可以将从服务器升级为主服务器，代替其执行写入命令



## 主从复制的实现

1. 主从服务器之间保持tcp长连接，主服务器周期性发送心跳包确保从服务器有效
2. 从服务器向主服务器发送sync命令
3. 主服务器收到命令，执行bgsave生成rdb文件，期间接收到的新命令存储到缓冲区
4. 主服务器将rdb发送给从服务器
5. 主服务器将缓冲区(长度固定的先进先出字符串)的数据发送给从服务器
6. 主服务器接收到客户端命令时，将命令转发给从服务器



这是一个完整的同步过程，但假设从服务器故障时间很短，可以拿缓冲区的命令进行恢复，那么执行让主服务器生成rdb显然是多余，因此2.8有提出新的方案



### 部分重同步

从服务器记录一个已同步命令的偏移量，主服务器记录缓冲区首字节偏移量

* 从服务器发送psync(2.8将sync改为psync)请求
* 主服务器判断从服务器的偏移量是否大于缓冲区首字节偏移量
  * 是，将缓冲区数据发送过去，这个称为**部分重同步**
  * 否，生成发送rdb，发送缓冲区数据，这个称为**完全重同步**



### 针对从服务器重启优化

从服务器的同步偏移量是保存在内存的，当从服务器重启的时候，偏移量丢失，需要向主服务器发送完全同步的请求

但显然假如重启的时间很短，这也是可以使用部分同步来恢复数据的

因此在4.0版本中进行优化，从服务器重启前生成rdb文件，并将同步偏移量一同保存进rdb，重启后根据这个同步偏移量判断是进行完全同步还是部分同步



## 非强一致性

* **processInputBufferAndReplicate**

  * 从服务器，直接执行指令

  * 主服务器

    * 执行指令

    * **replicationFeedSlavesFromMasterStream**

      * **feedReplicationBacklog**

        将指令放入缓冲区

      * 遍历从服务器、发送指令

主服务处理完写入指令后，向从服务器发送同步信息，但并不能保证从服务器完成，返回给客户端后，客户端立即向从服务器查询这个数据，假设数据未完成同步，可能查不到这个数据